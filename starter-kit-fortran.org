#+TITLE: Starter Kit Fortran
#+OPTIONS: toc:nil num:nil ^:nil

* Starter Kit Fortran

Fortran is a major language for scientific computation but a minor for other.

** Fortran config
#+BEGIN_SRC emacs-lisp
(defun my-f90-config ()
  (modify-syntax-entry ?_ "w")
  (f90-backslash-not-special)
  (when (> emacs-minor-version 3)
    (setq prettify-symbols-alist
          '(("/=" . ?≠)
            (">=" . ?≥)
            ("<=" . ?≤)))
    (prettify-symbols-mode 1))
  (evil-define-key 'normal f90-mode-map
    "J" 'my-f90-join-lines))
(eval-after-load "f90"
  `(progn
     (require 'f90-eldoc)
     (add-hook 'f90-mode-hook 'my-f90-config)))
#+END_SRC

** Fortran indent

Default indentation for Fortran is not that friendly.
#+BEGIN_SRC emacs-lisp
(setq fortran-do-indent 2)
(setq fortran-if-indent 2)
(setq fortran-structure-indent 2)
(setq fortran-continuation-indent 2)
(setq f90-do-indent 2)
(setq f90-if-indent 2)
(setq f90-structure-indent 2)
(setq f90-continuation-indent 2)
(setq f90-type-indent 2)
#+END_SRC

** Declaration align

Align variable declaration. Key binding is *C-c C-i*.

#+BEGIN_SRC emacs-lisp
(defun my-f90-align-declare ()
  "Align declaration of Fortran variables. The declaration before align
should have \"::\" and \"!\". Declaration like these are valid:

integer :: i ! an integer
type(SomeType) :: atype ! object of SomeType"
  (interactive)
  (let ((begin (region-beginning))
        (end (region-end)))
    (indent-region begin end)
    (align-regexp begin end "\\(\\s-*\\)::" 1 1 nil)
    (align-regexp begin end "::\\(\\s-*\\)" 1 1 nil)
    (align-regexp begin end "\\(\\s-*\\)!" 1 1 nil)))
(eval-after-load "f90"
  `(define-key f90-mode-map (kbd "C-c C-i") 'my-f90-align-declare))
#+END_SRC

** Fortran join lines

#+BEGIN_SRC emacs-lisp
(defun my-f90-join-lines ()
  (interactive)
  (if (region-active-p)
      (let* ((beg (region-beginning))
             (end (region-end))
             (nlines (1- (count-lines beg end)))
             arg)
        (when (= beg (point))
          (setq arg t))
        (dotimes (var nlines)
          (f90-join-lines arg)))
    (f90-join-lines t)))
#+END_SRC

** Some commands
1. f90-end-of-block
2. f90-beginning-of-block
3. ...
** F90 eldoc

#+begin_src emacs-lisp
(autoload 'f90-turn-on-eldoc-mode "f90-eldoc" "Turn on f90 eldoc mode" t)
#+end_src
