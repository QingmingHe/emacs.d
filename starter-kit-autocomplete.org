#+TITLE: Emacs Starter Auto Complete
#+OPTIONS: toc:2 num:nil ^:nil

* Starter Kit AC

** Basic setup
Use the default settings of auto complete but disable auto complete by default.
#+BEGIN_SRC emacs-lisp
(require 'auto-complete)
(require 'auto-complete-config)
(require 'auto-complete-clang)
(require 'auto-complete-etags)
(require 'pos-tip)
(require 'fuzzy)
(add-to-list 'ac-dictionary-directories "~/.emacs.d/elpa/auto-complete-20140322.321/dict")
;; add several modes to ac-modes so that global-auto-complete-mode can run on
;; these modes
(mapcar
 (lambda (mode)
   (add-to-list 'ac-modes mode))
 '(org-mode text-mode))
;; ac-sources for different languages
(add-hook 'f90-mode-hook
          '(lambda ()
             (setq ac-sources
                   (append '(ac-source-etags ac-source-yasnippet) ac-sources))))
(add-hook 'python-mode-hook
          '(lambda ()
             (setq ac-sources
                   (append '(ac-source-etags ac-source-yasnippet) ac-sources))))
(add-hook 'c-mode-common-hook
          '(lambda ()
             (setq ac-sources
                   (append '(ac-source-etags ac-source-yasnippet ac-source-clang) ac-sources))))
(add-hook 'org-mode-hook
          '(lambda ()
             (setq ac-sources
                   (append
                    '(ac-source-yasnippet ac-source-files-in-current-dir ac-source-filename)
                    ac-sources))))
(add-hook 'text-mode-hook
          '(lambda ()
             (setq ac-sources
                   (append '(ac-source-files-in-current-dir ac-source-filename) ac-sources))))
(ac-config-default)
(setq ac-quick-help-delay 0.5)
;; use pos-tip instead of popup to show doc perfectly
(setq ac-quick-help-prefer-pos-tip t)
;; fuzzy complete
(setq ac-fuzzy-enable t)
#+END_SRC

** Key bindings
Bind "M-/" to auto-complete
#+BEGIN_SRC emacs-lisp
(define-key ac-mode-map (kbd "M-n") 'ac-fuzzy-complete)
(define-key ac-mode-map (kbd "M-p") 'ac-fuzzy-complete)
(define-key ac-mode-map (kbd "<S-tab>") 'ac-previous)
#+END_SRC

** Set up for Backends
*** Clang for C and C++
Add include path, which can be obtained by *echo "" | g++ -v -x c++ -E -*, to
ac-clang backend.
#+BEGIN_SRC emacs-lisp
(defun get-c-include-path ()
  (with-temp-buffer
    (insert (shell-command-to-string "echo \"\" | g++ -v -x c++ -E -"))
    (goto-char (point-min))
    (search-forward "#include <...>")
    (next-line)
    (setq p1 (line-beginning-position))
    (search-forward "# 1")
    (previous-line)
    (previous-line)
    (setq p2 (line-end-position))
    (setq c-include-paths (split-string (buffer-substring-no-properties p1 p2)))
    (add-to-list 'c-include-paths ".")
    )
  )

(setq ac-clang-flags
      (mapcar (lambda (item)(concat "-I" item))
              (get-c-include-path)
              )
      )
#+END_SRC
